# Sysdig Monitor for Cloud in AWS<br/>[ Example :: Private Billing Single Account ]

Deploy Private Billing feature in a single AWS account.<br/>
All the required resources and workloads will be run under the same account.


### Notice
* **Resource creation inventory** Find all the resources created by Sysdig examples in the resource-group `sysdig-monitor-for-cloud` (AWS Resource Group & Tag Editor) <br/><br/>
* **Deployment cost** This example will create resources that cost money.<br/>Run `terraform destroy` when you don't need them anymore

![diagram](https://raw.githubusercontent.com/sysdiglabs/terraform-aws-monitor-for-cloud/main/examples/private-billing-single-account/diagram.png)

## Prerequisites

Minimum requirements:

1. Configure [Terraform **AWS** Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
2. Monitor requirements, as input variable value
    ```
    sysdig_monitor_api_token=<Sysdig API Key>
    sysdig_aws_account_id=<Sysdig AWS accountId>
    sysdig_external_id=<Sysdig external ID>
    ```


## Usage

For quick testing, use this snippet on your terraform files

```terraform
terraform {
    required_providers {
        sysdig = {
            source = "sysdiglabs/sysdig"
            version = ">= 1.41.0"
        }
    }
}

provider "aws" {
   region = "<AWS-REGION>"
}

provider "sysdig" {
   sysdig_monitor_url = "https://<sysdig-endpoint>"
   sysdig_monitor_api_token = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}

module "billing_module" {
    source = "sysdiglabs/monitor-for-cloud/aws//modules/private-billing"

    s3_bucket_name = "billing-bucket-test"
    s3_bucket_prefix = "billing-data"
    s3_athena_bucket_prefix = "athena-cur-query-results"
    sysdig_cost_access_role_name = "test-MonitoringRole"
    create_new_role = true
    sysdig_aws_account_id = "xxxx-xxxx-xxxx"
    sysdig_external_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

See [inputs summary](#inputs) or module module [`variables.tf`](https://github.com/sysdiglabs/terraform-aws-monitor-for-cloud/blob/master/examples/private-billing-single-account/variables.tf) file for more optional configuration.

To run this example you need have your [aws account profile configured in CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html) and to execute:
```terraform
$ terraform init
$ terraform plan
$ terraform apply
```

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3.7 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 4.0.0 |
| <a name="requirement_sysdig"></a> [sysdig](#requirement\_sysdig) | >= 1.41.0 |


## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_private_billing"></a> [private\_billing](#module\_private\_billing) | ../../modules/private-billing | n/a |

## Resources

| Name | Type |
|------|------|
| [sysdig_monitor_cloud_account.current](https://registry.terraform.io/providers/sysdiglabs/sysdig/latest/docs/resources/monitor_cloud_account) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
|<a name="s3_bucket_name"></a> [s3\_bucket\_name](#input\_s3\_bucket\_name) | Name of S3 bucket where Cost and Usage data will be generated | `string` | ` ` | yes |
|<a name="s3_bucket_prefix"></a> [s3\_bucket\_prefix](#input\_s3\_bucket\_prefix) | Prefix of CUR files inside S3 bucket | `string` | `billing-data` | yes |
|<a name="s3_athena_bucket_prefix"></a> [s3\_athena\_bucket\_prefix](#input\_s3\_athena\_bucket\_prefix) | Prefix of Athena results inside S3 bucket | `string` | `athena-cur-query-results` | yes |
|<a name="sysdig_cost_access_role_name"></a> [sysdig\_cost\_access\_role\_name](#input\_sysdig\_cost\_access\_role_name) | Name of role which will be granted permissions to access cost and billing data | `string` | `SysdigBillingIntegrationMonitoringRole` | yes |
|<a name="create_new_role"></a> [create\_new\_role](#input\_create\_new\_role) | Whether the role above already exists or should be created from scratch | `boolean` | false | yes |
|<a name="sysdig_aws_account_id"></a> [sysdig\_aws\_account\_id](#input\_sysdig\_aws\_account\_id) | AWS account used by Sysdig | `string` | ` ` | yes |
|<a name="sysdig_external_id"></a> [sysdig\_external\_id](#input\_sysdig\_external\_id) | ExternalID used by Sysdig when assuming role | `string` | ` ` | yes |
|<a name="spot_data_feed_bucket_name"></a> [spot\_data\_feed\_bucket\_name](#input\_spot\_data\_feed\_bucket\_name) | The bucket where the spot data feed is sent from the “Setting up the Spot Data feed” step | `string` | ` ` | no |
|<a name="sysdig_cost_report_file_name"></a> [sysdig\_cost\_report\_file\_name](#input\_sysdig\_cost\_report\_file\_name) | Name of the report file that will be generated by the AWS billing service | `string` | `sysdig_aws_private_billing` | no |
|<a name="sysdig_cost_crawler_name_suffix"></a> [sysdig\_cost\_crawler\_name\_suffix](#input\_sysdig\_cost\_crawler\_name\_suffix) | Name Suffix of the AWS Glue Crawler that will be created to crawl the CUR data | `string` | `sysdig_aws_private_billing` | no |
|<a name="tags"></a> [tags](#input\_tags) | Map of tags to apply to resources | `string map` | ` ` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_monitoring_role_name"></a> [monitoring\_role\_name](#output\_monitoring\_role\_name) | Name of the role which could be used to monitor cloudwatch metric stream |
| <a name="athena_bucket_name"></a> [monitoring\_role\_name](#output\_monitoring\_role\_name) | Name of the S3 bucket where the Athena query results are stored |
| <a name="athena_database_name"></a> [monitoring\_role\_name](#output\_monitoring\_role\_name) | Prefix of the S3 bucket where the Athena query results are stored |
| <a name="athena_region"></a> [monitoring\_role\_name](#output\_monitoring\_role\_name) | Region where the Athena query results are stored |
| <a name="athena_table_name"></a> [monitoring\_role\_name](#output\_monitoring\_role\_name) | Name of the Athena table |
| <a name="athena_workgroup_name"></a> [monitoring\_role\_name](#output\_monitoring\_role\_name) | Name of the Athena workgroup |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->


## Authors

Module is maintained and supported by [Sysdig](https://sysdig.com).

## License

Apache 2 Licensed. See LICENSE for full details.